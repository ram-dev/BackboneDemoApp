/*
 * Backbone.Courier, v1.0.4
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
(function(e,n){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],n):"undefined"!=typeof exports?module.exports=n(require("underscore"),require("backbone"),require("backbone").$):n(e._,e.Backbone,e.jQuery||e.Zepto||e.$)})(this,function(e,n,t){var r=/^(\S+)\s*(.*)$/,a=e.isFunction(t)?t("body")[0]:null;return n.Courier={},n.Courier.add=function(n){function t(n){e.isFunction(n.$el.data)&&!n.$el.data("view")&&n.$el.data("view",n)}function i(n,t,a){var i=[];for(var s in n){var o=s.match(r),u=o[1],l=o[2],d=RegExp(u.replace("*","[\\w]*"));d.test(t.name)&&(""===l||a._getChildViewNamed(l)===t.source)&&i.push({eventName:u,subviewName:l,value:n[s]})}return i.length>1&&(i=e.sortBy(i,function(e){var n=e.eventName.replace("*",""),t=""!==e.subviewName,r=(t?1e3:0)+n.length;return-r})),i.length?i[0].value:null}var s={setElement:n.setElement};n.spawn=function(t,r){if(e.isString(t))t={name:t,data:r};else if(e.isUndefined(t.name))throw Error("Undefined message name.");t.source=n,t.data=t.data||{},this.trigger(t.name,t.data);for(var a,s,o="!"===t.name.charAt(t.name.length-1),u=this._getParentView();u;){if(e.isObject(u.onMessages)&&(s=i(u.onMessages,t,u),null!==s)){var l=s;if(e.isFunction(l)||(l=u[s]),!l)throw Error('Method "'+s+'" does not exist');var d=l.call(u,t.data,t.source,t.name);if(o)return d}a=o;var c=e.result(u,"passMessages");if(e.isObject(c)&&(s=i(c,t,u),null!==s)){if("."===s);else{if(!e.isString(s))throw new TypeError("Values of passMessages hash should be strings.");t.name=s}a=!0}if(!a)break;t.source=u,u=u._getParentView()}if(o)throw Error('Round trip message "'+t.name+'" was not handled. All round trip messages must be handled.')},e.isFunction(n._getParentView)||(n._getParentView=function(){for(var n=null,t=this.$el.parent();t.length>0&&t[0]!==a;){var r=t.data("view");if(r&&e.isFunction(r.render)){n=r;break}t=t.parent()}return n}),e.isFunction(n._getChildViewNamed)||(n._getChildViewNamed=function(n){return e.isObject(this.subviews)?this.subviews[n]:null}),n.setElement=function(e,r){var a=s.setElement.call(this,e,r);return t(n),a},n.$el&&t(n)},n.Courier});